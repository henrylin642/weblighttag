**產品名稱** LightTag 5-LED 光定位（6DoF）
**版本** v0.1
**目的** 在 Web 端以手機相機辨識 5 顆藍燈定位點，計算相機相對 LightTag 的 6DoF 位姿與距離。

---

**1. 背景與問題定義**

LightTag 同時具備：
- 3 個數據燈條（用於 96-bit 光學編碼）
- 5 個藍燈定位燈珠（4 顆平面 + 1 顆中央突起）

本 PRD 聚焦於 **5 顆藍燈定位**，目標在無 App、純 Web 條件下完成定位。

---

**2. 目標（Goals）**

必達：
- 5 顆藍燈可在遠距離被偵測並穩定追蹤
- 以已知 3D 座標進行 PnP 解算，輸出 6DoF 位姿
- 直接輸出距離（m）

非目標（v0.1 不處理）：
- 全機型完美適配
- HDR/多幀去噪環境保證穩定
- 無視背景強光的極端場景

---

**3. 已知硬體結構（LED 3D 座標）**

座標系：+X 向右、+Y 向上、+Z 朝向相機，單位 mm

```
LED1: (33.65,  21.80,  0)
LED2: (33.65, -21.80,  0)
LED3: (-33.65, -21.80, 0)
LED4: (-33.65, 21.80,  0)
LED5: (0, 63.09, 20.10)  // 中央突起點
```

藍燈直徑：5 mm

---

**4. 系統總覽（High Level）**

相機影像 → 藍燈前處理 → 候選點偵測 → 幾何匹配（4+1） → PnP 解算 → 6DoF / 距離輸出 → 追蹤穩定化

---

**5. 功能需求**

**5.1 影像前處理**
- 藍燈遮罩（只保留藍色特徵點）
- HSV 手動調整（Hue/Sat/Val）
- 自動 HSV 校準（可關閉）

**5.2 候選點偵測**
- 主要偵測：藍色差分 `B - (R+G)/2`
- 自適應閾值（二值化）
- 形態學去噪（open/close）
- 圓度、面積、中心優先等條件過濾

**5.3 幾何匹配**
- 針對 4+1 幾何關係做匹配
- 用 PnP 重投影誤差評分
- 誤差最小者勝出

**5.4 追蹤與穩定**
- 偵測成功後進入追蹤（小視窗更新）
- 失敗回退重新偵測
- 節流避免畫面卡頓

**5.5 輸出**
- 6DoF 位姿（PnP）
- 距離（m）= sqrt(x^2 + y^2 + z^2) / 1000
- 顯示解析度與藍燈品質（像素直徑 / SNR）

**5.6 解析度控制**
- 1080p / 1440p / 4K 選擇
- 實際輸出依裝置回傳

---

**6. 目前開發記錄（摘要）**

已完成：
- 5 點幾何 + PnP 解算
- 藍燈遮罩 + HSV 調整
- 自動 HSV 校準（可關閉）
- 藍色差分偵測（替代 HSV 作主偵測）
- 自動偵測改為「持續狀態」
- 追蹤鎖定（局部更新）
- 距離顯示、解析度顯示、藍燈品質估算（像素直徑 / SNR）

---

**7. 目前遇到的問題**

1. **遠距離（>3m）偵測不穩定**
   - 點太小、SNR 低、雜點干擾
2. **HSV 在遠距離不穩**
   - 飽和度/亮度被壓低，藍燈被濾掉
3. **自動偵測偶爾卡頓**
   - OpenCV 偵測頻率過高 → 需節流
4. **手動點選不可行**
   - 3m 以上無法手點 → 必須自動偵測

---

**8. 未來開發計畫（更清晰版）**

**Phase 1：穩定 5m 偵測**
- 偵測主流程改為「藍色差分 + 自適應閾值」
- 加入更嚴格雜點抑制（面積/圓度/距離範圍）
- 加入動態偵測頻率（根據 fps 自調）

**Phase 2：幾何匹配強化**
- 使用「4+1 幾何一致性」作為前置篩選
- 以 PnP 重投影誤差作最終判定
- 多幀投票，排除短暫噪點

**Phase 3：追蹤與穩定輸出**
- 追蹤模式下使用 Kalman / EMA 平滑
- 信心分數（SNR + reprojection error）控制輸出
- 長時間漂移校正

**Phase 4：實測與校正**
- 1m / 3m / 5m / 8m / 10m 實測曲線
- 建立距離 vs 像素直徑 / SNR 的經驗模型
- 評估是否需硬體改版（燈距、亮度、直徑）

---

**9. 成功定義（v1 Gate）**

- 5m 距離可穩定偵測 5 顆藍燈
- PnP 位姿輸出穩定（連續 3 秒不掉點）
- 平均誤差 ≤ 10 cm（2–5m）

