<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Antigravity Optical ID Reader</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      window.Module = {
        onRuntimeInitialized() {
          window.__cvReady = true;
        }
      };
    </script>
  </head>
  <body>

    <!-- Full-screen video background -->
    <div class="video-layer">
      <div class="video-wrap">
        <video id="video" playsinline muted></video>
        <canvas id="processed"></canvas>
        <canvas id="overlay"></canvas>
      </div>
    </div>

    <!-- HUD: top-left title -->
    <div class="hud-top">
      <div class="hud-title">Antigravity Optical ID</div>
      <div class="hud-version">v1.2.9 Â· 2026-02-09</div>
    </div>

    <!-- HUD: top-right status -->
    <div class="status" id="status">Idle</div>

    <!-- HUD: floating action buttons above bottom panel -->
    <div class="hud-actions">
      <button id="btnStart">å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="btnStop" disabled>åœæ­¢</button>
      <button id="btnLocAuto" disabled style="background:#2a6a92;color:#fff;font-weight:bold;">ğŸ¯ è‡ªå‹•åµæ¸¬</button>
      <button id="btnLocClear" disabled>æ¸…é™¤</button>
    </div>

    <!-- Expand/collapse toggle -->
    <button class="panel-toggle" id="panelToggle">â–² å±•é–‹</button>

    <!-- Bottom panel: tabs with log + controls -->
    <div class="bottom-panel" id="bottomPanel">
      <div class="tab-bar" id="tabBar">
        <button class="active" data-tab="log">æ—¥èªŒ</button>
        <button data-tab="readout">è®€æ•¸</button>
        <button data-tab="config">è¨­å®š</button>
        <button data-tab="hsv">HSV</button>
      </div>
      <div class="tab-content">

        <!-- Tab: Log -->
        <div class="tab-page active" id="tab-log">
          <div class="log" id="log" style="height:100%;"></div>
        </div>

        <!-- Tab: Readout -->
        <div class="tab-page" id="tab-readout">
          <div class="output-row">
            <div><div class="label">PnP ç‹€æ…‹</div><div id="locStatus">-</div></div>
            <div><div class="label">è·é›¢ (m)</div><div id="locDist">-</div></div>
          </div>
          <div class="output-row">
            <div><div class="label">ä½ç½® (mm)</div><div id="locPos">-</div></div>
            <div><div class="label">å§¿æ…‹ (deg)</div><div id="locRot">-</div></div>
          </div>
          <div class="output-row">
            <div><div class="label">è§£æåº¦</div><div id="camRes">-</div></div>
            <div><div class="label">FPS</div><div id="camFps">-</div></div>
            <div><div class="label">DPR</div><div id="camDpr">-</div></div>
          </div>
          <div class="output-row">
            <div><div class="label">è—ç‡ˆå“è³ª</div><div id="ledQuality">-</div></div>
          </div>
          <div class="video-actions">
            <button id="btnLedQuality" disabled>ä¼°ç®—è—ç‡ˆå“è³ª</button>
            <button id="btnLocSolve" disabled>æ‰‹å‹•è¨ˆç®—å®šä½</button>
          </div>
          <div class="log" id="qualityLog"></div>
        </div>

        <!-- Tab: Config -->
        <div class="tab-page" id="tab-config">
          <div class="config-grid">
            <label>ç’°å¢ƒæ¨¡å¼
              <select id="cfgEnvMode" disabled>
                <option value="dark">æš—ç’°å¢ƒ (é–¾å€¼35)</option>
                <option value="normal" selected>æ­£å¸¸å®¤å…§ (é–¾å€¼40)</option>
                <option value="bright">æ˜äº®ç’°å¢ƒ (é–¾å€¼50)</option>
              </select>
            </label>
          </div>
          <div class="config-grid">
            <label>
              <input id="chkShowMask" type="checkbox" /> è—ç‡ˆé®ç½©
            </label>
            <label>
              <input id="chkMaskOnly" type="checkbox" /> åªé¡¯ç¤ºé®ç½©
            </label>
            <label>
              <input id="chkOnlyEnhance" type="checkbox" /> åªé¡¯ç¤ºå¼·åŒ–ç•«é¢
            </label>
          </div>
          <div class="config-grid">
            <label>fx <input id="cfgFx" type="number" step="1" /></label>
            <label>fy <input id="cfgFy" type="number" step="1" /></label>
            <label>cx <input id="cfgCx" type="number" step="1" /></label>
            <label>cy <input id="cfgCy" type="number" step="1" /></label>
          </div>
          <div class="video-actions">
            <button id="btnAutoHsv" disabled style="background:#2a7a52;">ğŸ¨ è‡ªå‹•æ ¡æº– HSV</button>
          </div>
        </div>

        <!-- Tab: HSV -->
        <div class="tab-page" id="tab-hsv">
          <div class="config-grid">
            <label>Hue Min
              <input id="cfgHueMin" type="range" min="180" max="260" step="1" value="192" />
              <span id="valHueMin">192</span>
            </label>
            <label>Hue Max
              <input id="cfgHueMax" type="range" min="180" max="260" step="1" value="260" />
              <span id="valHueMax">260</span>
            </label>
            <label>Sat Min
              <input id="cfgSatMin" type="range" min="0" max="1" step="0.01" value="0.74" />
              <span id="valSatMin">0.74</span>
            </label>
            <label>Val Min
              <input id="cfgValMin" type="range" min="0" max="1" step="0.01" value="0.70" />
              <span id="valValMin">0.70</span>
            </label>
          </div>
        </div>

      </div>
    </div>

    <script src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script src="geometry-based-detection.js"></script>
    <script src="app.js"></script>

    <!-- Tab switching + panel toggle logic -->
    <script>
    (function() {
      const tabBar = document.getElementById('tabBar');
      const toggle = document.getElementById('panelToggle');
      const panel = document.getElementById('bottomPanel');

      tabBar.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-tab]');
        if (!btn) return;
        // activate tab button
        tabBar.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // show tab page
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        const page = document.getElementById('tab-' + btn.dataset.tab);
        if (page) page.classList.add('active');
        // auto-expand when switching to non-log tab
        if (btn.dataset.tab !== 'log' && !panel.classList.contains('expanded')) {
          panel.classList.add('expanded');
          toggle.textContent = 'â–¼ æ”¶åˆ';
        }
      });

      toggle.addEventListener('click', function() {
        panel.classList.toggle('expanded');
        toggle.textContent = panel.classList.contains('expanded') ? 'â–¼ æ”¶åˆ' : 'â–² å±•é–‹';
        // recalculate video canvas size after transition
        setTimeout(function() {
          if (typeof resizeCanvases === 'function') resizeCanvases();
        }, 300);
      });
    })();
    </script>
  </body>
</html>
