<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Antigravity Optical ID Reader</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      window.Module = {
        onRuntimeInitialized() {
          window.__cvReady = true;
        }
      };
    </script>
  </head>
  <body>
    <div class="app">
      <header class="header">
        <div>
          <h1>Antigravity Optical ID Reader</h1>
          <p>Web-based LED optical ID decoding (96-bit payload → 16-bit core ID)</p>
        </div>
        <div class="status" id="status">Idle</div>
      </header>

      <main class="main">
        <section class="panel video-panel">
          <div class="video-fixed">
            <div class="video-wrap">
              <video id="video" playsinline muted></video>
              <canvas id="processed"></canvas>
              <canvas id="overlay"></canvas>
            </div>
          </div>
          <div class="video-spacer"></div>
          <div class="video-actions">
            <button id="btnStart">Start Camera</button>
            <button id="btnStop" disabled>Stop</button>
            <button id="btnAuto" disabled>Auto Detect LEDs</button>
            <button id="btnClear" disabled>Clear Points</button>
            <button id="btnDecode" disabled>Start Decode</button>
            <label class="toggle">
              <input id="chkBgSub" type="checkbox" disabled />
              背景弱化視圖
            </label>
            <label class="toggle">
              <input id="chkEnhance" type="checkbox" disabled checked />
              影像強化視圖
            </label>
            <label class="toggle">
              <input id="modeDataLed" name="clickMode" type="radio" checked />
              點選數據燈
            </label>
            <label class="toggle">
              <input id="modeLocLed" name="clickMode" type="radio" />
              點選定位燈
            </label>
          </div>
          <div class="hint">
            Click three LED positions on the video, or use Auto Detect. Points are stored per session.
          </div>
        </section>

        <section class="panel">
          <h2>影像強化</h2>
          <div class="config-grid">
            <label>單色通道
              <select id="cfgChannel">
                <option value="gray">Gray</option>
                <option value="red">Red</option>
                <option value="green">Green</option>
                <option value="blue">Blue</option>
              </select>
            </label>
            <label>亮度
              <input id="cfgBrightness" type="range" min="0.2" max="1.5" step="0.05" value="1" />
              <span id="valBrightness">1.00</span>
            </label>
            <label>對比
              <input id="cfgContrast" type="range" min="0.5" max="2.0" step="0.05" value="1" />
              <span id="valContrast">1.00</span>
            </label>
            <label>Gamma
              <input id="cfgGamma" type="range" min="0.5" max="2.5" step="0.05" value="1" />
              <span id="valGamma">1.00</span>
            </label>
            <label>
              <input id="chkHighPass" type="checkbox" />
              高通強化
            </label>
            <label>高通強度
              <input id="cfgHighPass" type="range" min="1" max="6" step="0.5" value="3" />
              <span id="valHighPass">3.0</span>
            </label>
            <label>
              <input id="chkRoiStretch" type="checkbox" />
              ROI 對比拉伸
            </label>
            <label>
              <input id="chkBlueMask" type="checkbox" />
              藍燈遮罩
            </label>
            <label>
              <input id="chkMaskOnly" type="checkbox" />
              只顯示遮罩
            </label>
            <label>
              <input id="chkOnlyEnhance" type="checkbox" checked />
              只顯示強化畫面
            </label>
            <label>Hue Min
              <input id="cfgHueMin" type="range" min="180" max="260" step="1" value="210" />
              <span id="valHueMin">210</span>
            </label>
            <label>Hue Max
              <input id="cfgHueMax" type="range" min="180" max="260" step="1" value="250" />
              <span id="valHueMax">250</span>
            </label>
            <label>Sat Min
              <input id="cfgSatMin" type="range" min="0" max="1" step="0.01" value="0.4" />
              <span id="valSatMin">0.40</span>
            </label>
            <label>Val Min
              <input id="cfgValMin" type="range" min="0" max="1" step="0.01" value="0.35" />
              <span id="valValMin">0.35</span>
            </label>
            <label>背景暗化
              <input id="cfgBgDim" type="range" min="0" max="1" step="0.05" value="0.4" />
              <span id="valBgDim">0.40</span>
            </label>
          </div>
        </section>

        <section class="panel">
          <h2>定位驗證 (5 藍燈)</h2>
          <div class="hint">
            切換「點選定位燈」，在畫面中依序點 5 顆藍燈。完成後點「計算定位」。
          </div>
          <div class="video-actions">
            <button id="btnLocClear" disabled>清除定位點</button>
            <button id="btnLocAuto" disabled>開始自動偵測</button>
            <button id="btnLocSolve" disabled>計算定位</button>
          </div>
          <div class="config-grid">
            <label>fx
              <input id="cfgFx" type="number" step="1" />
            </label>
            <label>fy
              <input id="cfgFy" type="number" step="1" />
            </label>
            <label>cx
              <input id="cfgCx" type="number" step="1" />
            </label>
            <label>cy
              <input id="cfgCy" type="number" step="1" />
            </label>
          </div>
          <div class="output-row">
            <div>
              <div class="label">PnP 狀態</div>
              <div id="locStatus">-</div>
            </div>
            <div>
              <div class="label">位置 (mm)</div>
              <div id="locPos">-</div>
            </div>
            <div>
              <div class="label">姿態 (deg)</div>
              <div id="locRot">-</div>
            </div>
          </div>
          <div class="output-row">
            <div>
              <div class="label">解析度</div>
              <div id="camRes">-</div>
            </div>
            <div>
              <div class="label">藍燈品質</div>
              <div id="ledQuality">-</div>
            </div>
          </div>
          <div class="video-actions">
            <button id="btnLedQuality" disabled>估算藍燈品質</button>
          </div>
          <div class="log" id="qualityLog"></div>
        </section>

        <section class="panel">
          <h2>Device Check</h2>
          <div class="device-grid">
            <div>
              <div class="label">Frame Rate</div>
              <div id="infoFps">-</div>
            </div>
            <div>
              <div class="label">Exposure Time</div>
              <div id="infoExposure">-</div>
            </div>
            <div>
              <div class="label">ISO / Gain</div>
              <div id="infoIso">-</div>
            </div>
            <div>
              <div class="label">Focus Mode</div>
              <div id="infoFocus">-</div>
            </div>
          </div>
          <div id="supportHint" class="support-hint"></div>
        </section>

        <section class="panel">
          <h2>Decoder Config</h2>
          <div class="config-grid">
            <label>Target Resolution
              <select id="cfgRes">
                <option value="1280x720">1280x720</option>
                <option value="1920x1080" selected>1920x1080</option>
                <option value="2560x1440">2560x1440</option>
                <option value="3840x2160">3840x2160 (4K)</option>
              </select>
            </label>
            <label>Target FPS
              <input id="cfgFps" type="number" min="10" max="60" value="25" />
            </label>
            <label>Target Exposure (us)
              <input id="cfgExposure" type="number" step="100" value="20000" />
            </label>
            <label>Target ISO
              <input id="cfgIso" type="number" step="1" value="750" />
            </label>
            <label>Frames Per Packet
              <input id="cfgFrames" type="number" min="8" max="128" value="32" />
            </label>
            <label>Bits Per Frame
              <input id="cfgBitsPerFrame" type="number" min="1" max="8" value="3" />
            </label>
            <label>Preamble Symbols (comma)
              <input id="cfgPreamble" type="text" value="7,0,7,0" />
            </label>
            <label>CRC Length (bits)
              <input id="cfgCrcLen" type="number" min="0" max="32" value="16" />
            </label>
            <label>CRC Poly (hex)
              <input id="cfgCrcPoly" type="text" value="0x1021" />
            </label>
            <label>CRC Init (hex)
              <input id="cfgCrcInit" type="text" value="0xFFFF" />
            </label>
            <label>CRC XorOut (hex)
              <input id="cfgCrcXor" type="text" value="0x0000" />
            </label>
            <label>ID Start Bit
              <input id="cfgIdStart" type="number" min="0" value="0" />
            </label>
            <label>ID Length
              <input id="cfgIdLen" type="number" min="1" max="32" value="16" />
            </label>
          </div>
        </section>

        <section class="panel">
          <h2>Live Metrics</h2>
          <div class="metrics">
            <div>
              <div class="label">Measured FPS</div>
              <div id="liveFps">-</div>
            </div>
            <div>
              <div class="label">LED Brightness</div>
              <div id="liveBrightness">-</div>
            </div>
            <div>
              <div class="label">Thresholds</div>
              <div id="liveThresholds">-</div>
            </div>
            <div>
              <div class="label">Last Symbol</div>
              <div id="liveSymbol">-</div>
            </div>
          </div>
          <div class="viz">
            <div class="label">LED Brightness Visualization (Normalized)</div>
            <div class="bars">
              <div class="bar-row">
                <span>LED 1</span>
                <div class="bar-track"><div id="bar1" class="bar-fill"></div></div>
                <span id="bar1Val">-</span>
              </div>
              <div class="bar-row">
                <span>LED 2</span>
                <div class="bar-track"><div id="bar2" class="bar-fill"></div></div>
                <span id="bar2Val">-</span>
              </div>
              <div class="bar-row">
                <span>LED 3</span>
                <div class="bar-track"><div id="bar3" class="bar-fill"></div></div>
                <span id="bar3Val">-</span>
              </div>
            </div>
          </div>
        </section>

        <section class="panel output">
          <h2>Output</h2>
          <div class="output-row">
            <div>
              <div class="label">Status</div>
              <div id="decodeStatus">Idle</div>
            </div>
            <div>
              <div class="label">ID</div>
              <div id="decodeId">-</div>
            </div>
            <div>
              <div class="label">CRC</div>
              <div id="decodeCrc">-</div>
            </div>
          </div>
          <div class="log" id="log"></div>
        </section>
      </main>
    </div>

    <script src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script src="app.js"></script>
  </body>
</html>
