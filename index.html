<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>WebTag 6DoF Locator</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="app">
      <!-- Camera layer (fullscreen) -->
      <video id="video" playsinline muted autoplay></video>

      <!-- WebGL processing canvas (hidden, used for GPU blue filter) -->
      <canvas id="gl-canvas" class="hidden-canvas"></canvas>

      <!-- Overlay canvas for visual feedback (positioned over video) -->
      <canvas id="overlay"></canvas>

      <!-- Start screen -->
      <div id="start-screen" class="start-screen">
        <div class="start-content">
          <h1>WebTag 6DoF Locator</h1>
          <p>瀏覽器端 5-LED 定位系統</p>
          <button id="btn-start" class="btn-primary">啟動相機</button>
          <p class="hint" id="version-hint">v2.3.2 - 無需 OpenCV</p>
        </div>
      </div>

      <!-- Settings drawer (slide-up from bottom) -->
      <div id="settings-drawer" class="drawer hidden">
        <div class="drawer-handle" id="drawer-handle">
          <div class="handle-bar"></div>
        </div>
        <div class="drawer-content">
          <h3>設定</h3>

          <!-- Detection sensitivity -->
          <div class="setting-group">
            <label>檢測靈敏度</label>
            <div class="btn-group">
              <button class="btn-option" data-sensitivity="low">低</button>
              <button class="btn-option active" data-sensitivity="medium">中</button>
              <button class="btn-option" data-sensitivity="high">高</button>
            </div>
          </div>

          <!-- Blue threshold -->
          <div class="setting-group">
            <label>藍光閾值: <span id="val-threshold">0.12</span></label>
            <input id="cfg-threshold" type="range" min="0.02" max="0.40" step="0.01" value="0.12" />
          </div>

          <!-- Brightness floor -->
          <div class="setting-group">
            <label>亮度門檻: <span id="val-brightness">0.15</span></label>
            <input id="cfg-brightness" type="range" min="0.05" max="0.60" step="0.01" value="0.15" />
          </div>

          <!-- Adaptive threshold toggle -->
          <div class="setting-group">
            <label>
              <input id="cfg-adaptive" type="checkbox" checked />
              自適應閾值
            </label>
          </div>

          <!-- Audio feedback toggle -->
          <div class="setting-group">
            <label>
              <input id="cfg-audio" type="checkbox" checked />
              音效反饋
            </label>
          </div>

          <!-- Mask view mode -->
          <div class="setting-group">
            <label>藍光遮罩顯示</label>
            <div class="btn-group">
              <button class="btn-option active" data-mask="off">關閉</button>
              <button class="btn-option" data-mask="overlay">疊加</button>
              <button class="btn-option" data-mask="only">僅藍光</button>
            </div>
          </div>

          <!-- HSV Hue Center -->
          <div class="setting-group">
            <label>色相中心: <span id="val-hue">227°</span></label>
            <input id="cfg-hue" type="range" min="0" max="360" step="1" value="227" />
          </div>

          <!-- HSV Hue Range -->
          <div class="setting-group">
            <label>色相範圍: <span id="val-hue-range">±30°</span></label>
            <input id="cfg-hue-range" type="range" min="5" max="180" step="1" value="30" />
          </div>

          <!-- HSV Saturation Min -->
          <div class="setting-group">
            <label>飽和度門檻: <span id="val-sat">0.25</span></label>
            <input id="cfg-sat" type="range" min="0" max="0.80" step="0.01" value="0.25" />
          </div>

          <!-- Camera intrinsics (advanced) -->
          <details class="advanced-settings">
            <summary>相機參數 (進階)</summary>
            <div class="setting-grid">
              <label>fx <input id="cfg-fx" type="number" step="1" placeholder="auto" /></label>
              <label>fy <input id="cfg-fy" type="number" step="1" placeholder="auto" /></label>
              <label>cx <input id="cfg-cx" type="number" step="1" placeholder="auto" /></label>
              <label>cy <input id="cfg-cy" type="number" step="1" placeholder="auto" /></label>
            </div>
          </details>

          <div class="drawer-actions">
            <button id="btn-stop" class="btn-secondary">停止相機</button>
            <button id="btn-reset" class="btn-secondary">重置追蹤</button>
            <button id="btn-reset-params" class="btn-secondary">重置參數</button>
          </div>
        </div>
      </div>

      <!-- Settings toggle button (gear icon) -->
      <button id="btn-settings" class="btn-settings hidden">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>
    </div>

    <!-- Load modules (no OpenCV!) -->
    <script src="blue-filter.js"></script>
    <script src="peak-detector.js"></script>
    <script src="blob-detector.js"></script>
    <script src="geometry-matcher.js"></script>
    <script src="pnp-solver.js"></script>
    <script src="kalman.js"></script>
    <script src="feedback.js"></script>
    <script src="app.js"></script>
  </body>
</html>
